<script>
/* === Receipt button + printable receipt (auto-calc + custom override + filename) === */
(function(){
  // ----- Brand header (edit if you change your name/tag/phone) -----
  const COMPANY_NAME  = "Augusta Sand & Gravel";
  const COMPANY_TAG   = "Material Hauling";
  const COMPANY_PHONE = ""; // e.g. "(706) 555-1234" or leave empty

  // Currency helper
  const fmt = v => (isFinite(v) ? Number(v).toFixed(2) : "");

  // Build + print the receipt for a job
  function generateReceipt(job){
    const css = `
      *{box-sizing:border-box}
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:24px;color:#111}
      h1{margin:0;font-size:22px}
      h2{margin:2px 0 12px;color:#475569;font-size:12px}
      .row{display:flex;gap:16px;margin-top:10px}
      .col{flex:1}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;font-size:12px}
      thead{background:#f8fafc}
      .muted{color:#64748b;font-size:12px;margin-top:8px}
    `;

    // Filename from date + customer
    const clean = s => (s||"").toString().trim().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/gi,"");
    const dateStr = job.date || new Date().toISOString().slice(0,10);
    const nameStr = clean(job.customer || "Customer");
    const fileName = `ASG_Receipt_${dateStr}_${nameStr}.pdf`;

    // Pull data from job
    const qtyRaw   = job.loadSize ?? 0;
    const savedTotal = job.price ?? 0; // might already be a total you set when scheduling
    const qty = Number(qtyRaw) || 0;

    // 1) Ask price per unit (defaults to derived total/qty if present)
    const derivedUnit = (qty > 0 && isFinite(savedTotal)) ? (Number(savedTotal) / qty) : "";
    const unitPrompt  = prompt("Price per unit ($/ton). Leave blank to use derived or existing:", derivedUnit ? Number(derivedUnit).toFixed(2) : "");
    const unitPrice   = unitPrompt === null
      ? (derivedUnit || 0)                  // cancel → fall back
      : (unitPrompt.trim()==="" ? (derivedUnit||0) : Number(unitPrompt));

    // 2) Auto-calc total; allow manual override
    const autoTotal   = (isFinite(qty) && isFinite(unitPrice)) ? qty * unitPrice : (Number(savedTotal)||0);
    const totalPrompt = prompt("Total price ($). You can override:", fmt(autoTotal));
    const grandTotal  = totalPrompt === null ? autoTotal : (Number(totalPrompt)||0);

    // 3) Payment + notes (optional)
    const method = prompt("Payment method (Cash, CashApp, Venmo, Zelle, Card):", "Cash") || "Cash";
    const notes  = prompt("Notes (optional):", "") || "";

    const html = `
      <!doctype html><html>
        <head>
          <meta charset="utf-8">
          <title>${fileName}</title>
          <style>${css}</style>
        </head>
        <body>
          <h1>${COMPANY_NAME}</h1>
          <h2>${[COMPANY_TAG, COMPANY_PHONE].filter(Boolean).join(" • ")}</h2>

          <div class="row">
            <div class="col"><strong>Customer:</strong> ${job.customer || ""}</div>
            <div class="col"><strong>Date:</strong> ${job.date || ""} ${job.time || ""}</div>
          </div>

          <table>
            <thead>
              <tr><th>Material</th><th>Quantity</th><th>Unit</th><th>Price/Unit</th><th>Total</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>${job.material || ""}</td>
                <td>${qty || ""}</td>
                <td>tons</td>
                <td>$${fmt(unitPrice)}</td>
                <td>$${fmt(grandTotal)}</td>
              </tr>
            </tbody>
          </table>

          <div class="row" style="margin-top:8px">
            <div class="col"><strong>Delivery Address:</strong><br>${job.address || ""}</div>
            <div class="col"><strong>Payment Method:</strong> ${method}</div>
          </div>

          <p class="muted">Notes: ${notes || "—"}</p>
          <p class="muted">Thank you for your business!</p>

          <script>window.print();<\/script>
        </body>
      </html>
    `;

    const w = window.open("", "receipt");
    w.document.write(html);
    w.document.close();
    // Many desktop browsers use <title> as default filename for "Save as PDF"
  }

  // Hook into your renderList to inject a "Receipt" button on each job card
  const origRender = window.renderList;
  window.renderList = function(){
    if (typeof origRender === "function") origRender.apply(this, arguments);

    document.querySelectorAll("#list > div[data-id]").forEach(card => {
      if (card.querySelector(".btn-receipt")) return;

      const rightCol = card.querySelector(".flex.flex-col.gap-2.items-end") || card;
      const actions  = rightCol.querySelector("div.flex.gap-2") || rightCol;

      const btn = document.createElement("button");
      btn.className = "btn-receipt rounded-xl px-3 py-1 border text-sm";
      btn.textContent = "Receipt";
      btn.onclick = () => {
        const id  = card.dataset.id;
        const job = (window.jobs || []).find(j => j.id === id);
        if (!job) return alert("Job not found.");
        generateReceipt(job);
      };

      actions.insertBefore(btn, actions.firstChild);
    });
  };

  // Attach after first render
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => window.renderList && window.renderList());
  } else {
    window.renderList && window.renderList();
  }
})();
</script>
