<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hauling App (Skeleton)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:20px;color:#111;background:#fafafa}
    .wrap{max-width:780px;margin:auto}
    h1{margin:0 0 16px}
    .job{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:#6b7280;font-size:12px}
    .btn{border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:6px 10px;font-weight:600;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    label{font-size:12px;color:#374151}
    input{border:1px solid #d1d5db;border-radius:10px;padding:6px 10px}
    .pill{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Hauling Job Manager</h1>
    <p class="muted">Demo skeleton with auto‑calculating receipts + optional custom totals (no tax).</p>

    <div id="jobList"></div>

    <hr style="margin:20px 0;border:none;border-top:1px solid #e5e7eb">
    <div class="row">
      <div>
        <label>Quick add (demo)</label><br>
        <input id="nameI" placeholder="Customer" />
        <input id="matI" placeholder="Material" />
        <input id="tonsI" type="number" step="0.01" placeholder="Tons" style="width:100px" />
        <input id="ppI" type="number" step="0.01" placeholder="$/ton" style="width:100px" />
        <button class="btn primary" id="addBtn">Add Job</button>
      </div>
    </div>
  </div>

<script>
/* -------------------------
   Minimal job data + UI
--------------------------*/
let jobs = [
  { id: crypto.randomUUID(), customer: "John Smith",  material: "Crush & Run", tons: 3, pricePerTon: 60, customTotal: null, address:"123 Oak Ln, Evans, GA", time:"" },
  { id: crypto.randomUUID(), customer: "Mary Jones",  material: "#57 Stone",  tons: 4, pricePerTon: 70, customTotal: null, address:"45 Maple Dr, Appling, GA", time:"" }
];

function computeTotal(job){
  return (job.customTotal != null && !isNaN(job.customTotal))
    ? Number(job.customTotal)
    : Number(job.tons||0) * Number(job.pricePerTon||0);
}

function renderList(){
  const el = document.getElementById("jobList");
  el.innerHTML = "";
  jobs.forEach(job => {
    const div = document.createElement("div");
    div.className = "job";
    const total = computeTotal(job);
    div.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${job.customer}</div>
          <div class="muted">${job.material} • ${job.tons} tons • $${Number(job.pricePerTon||0).toFixed(2)}/ton</div>
          ${job.customTotal!=null ? `<div class="pill">Custom total set</div>` : ""}
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="setCustom(${JSON.stringify(job.id)})">Set Custom Total</button>
          <button class="btn" onclick="clearCustom(${JSON.stringify(job.id)})">Clear Custom</button>
          <button class="btn primary" onclick="generateReceipt(${JSON.stringify(job.id)})">Receipt</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">Current total: <strong>$${isFinite(total)?total.toFixed(2):""}</strong></div>
    `;
    el.appendChild(div);
  });
}

document.getElementById("addBtn").onclick = ()=>{
  const name = document.getElementById("nameI").value.trim() || "Customer";
  const mat  = document.getElementById("matI").value.trim()  || "Material";
  const tons = Number(document.getElementById("tonsI").value || 0);
  const pp   = Number(document.getElementById("ppI").value   || 0);
  jobs.unshift({ id: crypto.randomUUID(), customer:name, material:mat, tons, pricePerTon:pp, customTotal:null, address:"", time:"" });
  renderList();
  ["nameI","matI","tonsI","ppI"].forEach(id=>document.getElementById(id).value="");
};

function setCustom(id){
  const j = jobs.find(x=>x.id===id); if(!j) return;
  const v = prompt("Custom total ($). Leave blank to cancel:", j.customTotal!=null?String(j.customTotal):"");
  if (v===null) return;
  const n = Number(v);
  if (isNaN(n)) { alert("Not a number."); return; }
  j.customTotal = n;
  renderList();
}
function clearCustom(id){
  const j = jobs.find(x=>x.id===id); if(!j) return;
  j.customTotal = null;
  renderList();
}

/* ----------------------------------------
   Receipt: auto-calc + manual override
   + suggested filename (no tax)
-----------------------------------------*/
const COMPANY_NAME  = "Augusta Sand & Gravel";
const COMPANY_TAG   = "Material Hauling";
const COMPANY_PHONE = ""; // optional

const fmt = v => (isFinite(v) ? Number(v).toFixed(2) : "");
const todayStr = () => new Date().toISOString().slice(0,10);
const clean = s => (s||"").toString().trim().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/gi,"");

function generateReceipt(id){
  const job = jobs.find(j=>j.id===id);
  if(!job){ alert("Job not found"); return; }

  const qty = Number(job.tons||0);
  // Prefer explicit pricePerTon; otherwise derive from existing custom/auto total
  const existingTotal = computeTotal(job);
  const derivedUnit = (qty>0 && isFinite(existingTotal)) ? (existingTotal/qty) : Number(job.pricePerTon||0);

  // 1) Ask $/ton (defaults to derived or job.pricePerTon)
  const unitPrompt = prompt("Price per unit ($/ton). Leave blank to use current:", derivedUnit?derivedUnit.toFixed(2):"");
  const unitPrice  = unitPrompt===null
      ? (derivedUnit||0)  // cancel → fallback
      : (unitPrompt.trim()==="" ? (derivedUnit||0) : Number(unitPrompt));

  // 2) Auto total → allow override
  const autoTotal  = (isFinite(qty) && isFinite(unitPrice)) ? (qty * unitPrice) : existingTotal;
  const totalPrompt = prompt("Total price ($). You can override:", fmt(autoTotal));
  const grandTotal  = totalPrompt===null ? autoTotal : (Number(totalPrompt)||0);

  // 3) Optional details
  const method = prompt("Payment method (Cash, CashApp, Venmo, Zelle, Card):", "Cash") || "Cash";
  const notes  = prompt("Notes (optional):", "") || "";

  // Suggested filename
  const fileName = `ASG_Receipt_${todayStr()}_${clean(job.customer||"Customer")}.pdf`;

  const css = `
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:24px;color:#111}
    h1{margin:0;font-size:22px}
    h2{margin:2px 0 12px;color:#475569;font-size:12px}
    .row{display:flex;gap:16px;margin-top:10px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;font-size:12px}
    thead{background:#f8fafc}
    .muted{color:#64748b;font-size:12px;margin-top:8px}
  `;

  const html = `
    <!doctype html><html>
      <head>
        <meta charset="utf-8">
        <title>${fileName}</title>
        <style>${css}</style>
      </head>
      <body>
        <h1>${COMPANY_NAME}</h1>
        <h2>${[COMPANY_TAG, COMPANY_PHONE].filter(Boolean).join(" • ")}</h2>

        <div class="row">
          <div class="col"><strong>Customer:</strong> ${job.customer||""}</div>
          <div class="col"><strong>Date:</strong> ${todayStr()} ${job.time||""}</div>
        </div>

        <table>
          <thead>
            <tr><th>Material</th><th>Quantity</th><th>Unit</th><th>Price/Unit</th><th>Total</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>${job.material||""}</td>
              <td>${qty||""}</td>
              <td>tons</td>
              <td>$${fmt(unitPrice)}</td>
              <td>$${fmt(grandTotal)}</td>
            </tr>
          </tbody>
        </table>

        <div class="row" style="margin-top:8px">
          <div class="col"><strong>Address:</strong><br>${job.address||""}</div>
          <div class="col"><strong>Payment Method:</strong> ${method}</div>
        </div>

        <p class="muted">Notes: ${notes || "—"}</p>
        <p class="muted">Thank you for your business!</p>

        <script>window.print();<\/script>
      </body>
    </html>
  `;
  const w = window.open("", "receipt");
  w.document.write(html);
  w.document.close();
}

// initial paint
renderList();
</script>
</body>
</html>
<script>
/* Robust receipt: handles popup blockers + missing job gracefully */
(function(){
  // keep your header text here (edit if needed)
  const COMPANY_NAME  = "Augusta Sand & Gravel";
  const COMPANY_TAG   = "Material Hauling";
  const COMPANY_PHONE = "";

  const fmt = v => (isFinite(v) ? Number(v).toFixed(2) : "");
  const todayStr = () => new Date().toISOString().slice(0,10);
  const clean = s => (s||"").toString().trim().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/gi,"");

  // Replace or define generateReceipt
  window.generateReceipt = function(idOrJob){
    // Resolve the job: support passing id or the job object
    let job = null;
    if (idOrJob && typeof idOrJob === "object") {
      job = idOrJob;
    } else {
      const id = String(idOrJob ?? "");
      job = (window.jobs || []).find(j => String(j.id) === id) || null;
    }
    if (!job) {
      alert("Couldn't find that job. Try refreshing the page.");
      return;
    }

    const qty = Number(job.loadSize ?? job.tons ?? 0);
    const existingTotal = Number(job.price ?? job.customTotal ?? 0);
    const derivedUnit = (qty>0 && isFinite(existingTotal) && existingTotal>0)
      ? (existingTotal/qty)
      : Number(job.pricePerTon ?? 0);

    // Ask for $/unit
    const unitPrompt = prompt("Price per unit ($/ton). Leave blank to use current:", derivedUnit ? derivedUnit.toFixed(2) : "");
    const unitPrice  = unitPrompt === null
      ? (derivedUnit || 0)
      : (unitPrompt.trim()==="" ? (derivedUnit||0) : Number(unitPrompt));

    // Auto total → allow override
    const autoTotal   = (isFinite(qty) && isFinite(unitPrice)) ? (qty * unitPrice) : (existingTotal || 0);
    const totalPrompt = prompt("Total price ($). You can override:", fmt(autoTotal));
    const grandTotal  = totalPrompt === null ? autoTotal : (Number(totalPrompt)||0);

    const method = prompt("Payment method (Cash, CashApp, Venmo, Zelle, Card):", "Cash") || "Cash";
    const notes  = prompt("Notes (optional):", "") || "";

    const fileName = `ASG_Receipt_${todayStr()}_${clean(job.customer||"Customer")}.pdf`;
    const css = `
      *{box-sizing:border-box}
      body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:24px;color:#111}
      h1{margin:0;font-size:22px}
      h2{margin:2px 0 12px;color:#475569;font-size:12px}
      .row{display:flex;gap:16px;margin-top:10px}
      .col{flex:1}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;font-size:12px}
      thead{background:#f8fafc}
      .muted{color:#64748b;font-size:12px;margin-top:8px}
    `;

    const html = `
      <!doctype html><html>
        <head><meta charset="utf-8"><title>${fileName}</title><style>${css}</style></head>
        <body>
          <h1>${COMPANY_NAME}</h1>
          <h2>${[COMPANY_TAG, COMPANY_PHONE].filter(Boolean).join(" • ")}</h2>

          <div class="row">
            <div class="col"><strong>Customer:</strong> ${job.customer||""}</div>
            <div class="col"><strong>Date:</strong> ${job.date||todayStr()} ${job.time||""}</div>
          </div>

          <table>
            <thead>
              <tr><th>Material</th><th>Quantity</th><th>Unit</th><th>Price/Unit</th><th>Total</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>${job.material || ""}</td>
                <td>${qty || ""}</td>
                <td>tons</td>
                <td>$${fmt(unitPrice)}</td>
                <td>$${fmt(grandTotal)}</td>
              </tr>
            </tbody>
          </table>

          <div class="row" style="margin-top:8px">
            <div class="col"><strong>Address:</strong><br>${job.address||""}</div>
            <div class="col"><strong>Payment Method:</strong> ${method}</div>
          </div>

          <p class="muted">Notes: ${notes || "—"}</p>
          <p class="muted">Thank you for your business!</p>
          <script>window.print();<\/script>
        </body>
      </html>
    `;

    // Open in a user-gesture to avoid popup blockers
    const w = window.open("", "_blank"); 
    if (!w || w.closed || typeof w.closed === "undefined") {
      alert("Your browser blocked the receipt window. Please allow pop‑ups for this site and try again.");
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();
  };

  // Reattach buttons in case your renderList didn't wire them
  function attachReceiptButtons(){
    const list = document.getElementById("list");
    if (!list) return;
    const cards = Array.from(list.children).filter(el => el && el.nodeType === 1);
    const visible = (typeof window.filteredJobs === "function") ? window.filteredJobs() : (window.jobs || []);

    cards.forEach((card, idx) => {
      if (card.querySelector(".btn-receipt")) return;

      const rightCol = card.querySelector(".flex.flex-col.gap-2.items-end") || card;
      const actions  = rightCol.querySelector("div.flex.gap-2") || rightCol;

      const btn = document.createElement("button");
      btn.className = "btn-receipt rounded-xl px-3 py-1 border text-sm";
      btn.textContent = "Receipt";

      // resolve job by data-id or by visible index (fallback)
      let job = null;
      const id = card.dataset && card.dataset.id;
      if (id && Array.isArray(window.jobs)) job = window.jobs.find(j => String(j.id) === String(id)) || null;
      if (!job) job = visible[idx] || null;

      btn.onclick = () => window.generateReceipt(job || (id ?? null));
      actions.insertBefore(btn, actions.firstChild || null);
    });
  }

  // Wrap renderList so every render adds buttons
  const origRender = window.renderList;
  window.renderList = function(){
    if (typeof origRender === "function") origRender.apply(this, arguments);
    attachReceiptButtons();
  };

  // Run once on load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", attachReceiptButtons);
  } else {
    attachReceiptButtons();
  }
})();
</script>
