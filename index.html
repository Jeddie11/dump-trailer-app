<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ASG App — Safe Build</title>
<style>
  :root{--bg:#0b0b0c;--card:#141416;--muted:#a8adb7;--text:#eef1f6;--accent:#facc15;--line:#232428}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:640px;margin:0 auto;padding:16px}
  h1{font-size:20px;margin:6px 0 14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  select, input{width:100%;background:#0e0f11;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .price{font-size:22px;margin:6px 0 0}
  .muted{color:var(--muted);font-size:12px}
  .ok{color:#a7f3d0}
  .warn{color:#fde68a}
  .footer{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>Augusta Sand &amp; Gravel — Quote</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="materialI">Material</label>
        <select id="materialI"></select>
      </div>
      <div>
        <label for="qtyI">Quantity</label>
        <select id="qtyI"></select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label for="zoneI">Zone</label>
        <select id="zoneI">
          <option value="Z1">Zone 1</option>
          <option value="Z2">Zone 2</option>
        </select>
      </div>
      <div>
        <label for="priceO">Price</label>
        <input id="priceO" type="text" readonly placeholder="$0" />
      </div>
    </div>
    <div style="margin-top:10px">
      <div class="muted">Prices include delivery. App uses locked **Aug 2025** master sheet.</div>
    </div>
  </div>

  <div class="card">
    <div class="muted">Debug quick-check</div>
    <div id="debug" class="muted">…</div>
  </div>

  <div class="footer">© Augusta Sand &amp; Gravel</div>
</div>

<script>
// =======================
// MASTER PRICING (LATEST)
// =======================
// HAULING_MASTER_PRICING_V2 — locked master (Aug 2025)
const MASTER_PRICING = {
  version: "HAULING_MASTER_PRICING_V2",
  quarryCosts: {
    crush_and_run_per_ton: 23,
    stone_57_per_ton: 29,
    stone_4_per_ton: 29,        // assumed until updated
    fill_dirt_per_yd: 0,        // stockpile
    top_soil_per_yd: 10,
    clean_sand_per_yd: 0,
    sand_clay_per_yd: 0
  },
  // materials MUST remain an ARRAY
  materials: [
    {
      key: "fill_dirt",
      name: "Fill Dirt",
      unit: "ton",
      zones: {
        Z1: { "1": 100, "2": 120, "3": 150, "4": 200 },
        Z2: { "1": 100, "2": 120, "3": 150, "4": 200 }
      }
    },
    {
      key: "crush_and_run",
      name: "Crush & Run",
      unit: "ton",
      zones: {
        Z1: { "1": 100, "2": 140, "3": 180, "4": 240 },
        Z2: { "1": 100, "2": 200, "3": 275, "4": 350 }
      }
    },
    {
      key: "stone_57",
      name: "#57 Stone",
      unit: "ton",
      zones: {
        Z1: { "1": 100, "2": 140, "3": 210, "4": 280 },
        Z2: { "1": 100, "2": 200, "3": 305, "4": 390 }
      }
    },
    {
      key: "stone_4",
      name: "#4 Stone",
      unit: "ton",
      zones: {
        Z1: { "1": 100, "2": 140 },
        Z2: { "1": 100, "2": 200 }
      }
    }
  ]
};

// -------------------------------------------------------
// SAFETY SHIM: guarantee materials is an array at runtime
// -------------------------------------------------------
(function () {
  const m = window.MASTER_PRICING;
  if (!m) return;
  if (!Array.isArray(m.materials)) {
    m.materials = (m.materials && typeof m.materials === "object")
      ? Object.values(m.materials)
      : [];
  }
})();

// -----------------------
// Minimal app logic
// -----------------------
const materialI = document.getElementById('materialI');
const qtyI      = document.getElementById('qtyI');
const zoneI     = document.getElementById('zoneI');
const priceO    = document.getElementById('priceO');
const debugO    = document.getElementById('debug');

function dbg(s){ debugO.textContent = String(s); }

function materialsArray(){
  const m = MASTER_PRICING || {};
  if (Array.isArray(m.materials)) return m.materials;
  if (m.materials && typeof m.materials === 'object') return Object.values(m.materials);
  return [];
}

function masterMaterialFor(name){
  const m = MASTER_PRICING || {};
  const arr = Array.isArray(m.materials) ? m.materials
           : (m.materials && typeof m.materials === 'object' ? Object.values(m.materials) : []);
  return arr.find(x => x && x.name === name);
}

function repopulateMaterialOptions(){
  materialI.innerHTML = '';
  for (const mat of materialsArray()){
    const opt = document.createElement('option');
    opt.value = mat.name;
    opt.textContent = mat.name;
    materialI.appendChild(opt);
  }
}

function repopulateQtyOptions(){
  qtyI.innerHTML = '';
  const mat = masterMaterialFor(materialI.value);
  const z = (zoneI.value || 'Z1');
  if (!mat || !mat.zones || !mat.zones[z]) return;
  const quantities = Object.keys(mat.zones[z]).sort((a,b)=>Number(a)-Number(b));
  for (const q of quantities){
    const opt = document.createElement('option');
    opt.value = q;
    opt.textContent = q + ' ' + (mat.unit === 'ton' ? 'ton' + (q==='1'?'':'s') : mat.unit);
    qtyI.appendChild(opt);
  }
}

function updatePrice(){
  const mat = masterMaterialFor(materialI.value);
  const z = (zoneI.value || 'Z1');
  const q = qtyI.value;
  const price = mat?.zones?.[z]?.[q];
  priceO.value = (typeof price === 'number') ? `$${price}` : '';
  dbg(`v${MASTER_PRICING.version} | ${Array.isArray(MASTER_PRICING.materials) ? 'materials:Array' : 'materials:Converted'} | ${materialI.value || '-'} ${z} ${q || '-'} => ${priceO.value || '-'}`);
}

// Wire up
materialI.onchange = () => { repopulateQtyOptions(); updatePrice(); };
zoneI.onchange     = () => { repopulateQtyOptions(); updatePrice(); };
qtyI.onchange      = () => { updatePrice(); };

// Init
repopulateMaterialOptions();
repopulateQtyOptions();
updatePrice();
</script>
</body>
</html>
