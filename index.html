<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dump Trailer — iPhone</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAASUlEQVR42u3OMQEAIAwEsbT9ZxSgZqg0E1gD7y5w2gAAAPxXv3gAAAD8Z2hCAAAAAPwMAAAA/DAAAAD8DAAAAPwwAAAA/AwAAAD8MJD3A7lJkqT4AAAAAElFTkSuQmCC">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{-webkit-tap-highlight-color:transparent}</style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    function App() {
      const emptyJob = () => ({
        id: (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
        date: new Date().toISOString().slice(0,10),
        time: "",
        customer: "",
        address: "",
        material: "",
        loadSize: "",
        price: "",
        status: "Scheduled",
      });

      const readLS = (k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}};
      const writeLS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

      const [hubs,setHubs]=useState(()=>readLS("dt_hubs",[
        "Sample & Son, Evans, GA",
        "4567 Chamberlain Ferry Rd, Lincolnton, GA 30817",
      ]));
      const [selectedHub,setSelectedHub]=useState(()=>readLS("dt_selected_hub","Sample & Son, Evans, GA"));
      const [jobs,setJobs]=useState(()=>readLS("dt_jobs",[]));
      const [tab,setTab]=useState("today");
      const [compose,setCompose]=useState(emptyJob());
      const [pasteText,setPasteText]=useState("");

      useEffect(()=>writeLS("dt_hubs",hubs),[hubs]);
      useEffect(()=>writeLS("dt_selected_hub",selectedHub),[selectedHub]);
      useEffect(()=>writeLS("dt_jobs",jobs),[jobs]);

      const todayStr=new Date().toISOString().slice(0,10);
      const tomorrowStr=new Date(Date.now()+86400000).toISOString().slice(0,10);

      const filtered=useMemo(()=>{
        const withinWeek=(d)=>{
          const dt=new Date(d+'T00:00:00');
          const start=new Date(); start.setHours(0,0,0,0);
          const end=new Date(start); end.setDate(end.getDate()+6);
          return dt>=start && dt<=end;
        };
        switch(tab){
          case "today": return jobs.filter(j=>j.date===todayStr && j.status!=="Complete" && j.status!=="Canceled");
          case "tomorrow": return jobs.filter(j=>j.date===tomorrowStr && j.status!=="Complete" && j.status!=="Canceled");
          case "week": return jobs.filter(j=>withinWeek(j.date) && j.status!=="Complete" && j.status!=="Canceled");
          case "all":
          default: return jobs;
        }
      },[jobs,tab]);

      const addJob=()=>{
        if(!compose.address || !compose.customer) return;
        setJobs(p=>[...p,{...compose,id:(crypto&&crypto.randomUUID?crypto.randomUUID():String(Date.now()+Math.random()))}]);
        setCompose(emptyJob());
      };
      const removeJob=(id)=>setJobs(p=>p.filter(j=>j.id!==id));
      const updateJob=(id,patch)=>setJobs(p=>p.map(j=>j.id===id?{...j,...patch}:j));
      const addHub=(addr)=>{ if(!addr) return; setHubs(p=>[...new Set([...p,addr])]); setSelectedHub(addr); };

      const pasteRows=()=>{
        const lines=pasteText.split(/\n+/).map(l=>l.trim()).filter(Boolean);
        if(!lines.length) return;
        const out=[];
        for(const line of lines){
          let parts=line.split(/\t/);
          if(parts.length<2) parts=line.split(/\s*,\s*/);
          const [d,t,cust,addr,mat,size,price,status]=parts;
          const row={
            id:(crypto&&crypto.randomUUID?crypto.randomUUID():String(Date.now()+Math.random())),
            date: d && /\d{4}-\d{2}-\d{2}|\d{1,2}\/(\d{1,2})\/(\d{2,4})/.test(d) ? normalizeDate(d) : todayStr,
            time: t||"",
            customer: cust||"",
            address: addr||"",
            material: mat||"",
            loadSize: size||"",
            price: price||"",
            status: status||"Scheduled",
          };
          if(row.address) out.push(row);
        }
        if(out.length) setJobs(p=>[...p,...out]);
        setPasteText("");
      };

      function normalizeDate(input){
        if(/^\d{4}-\d{2}-\d{2}$/.test(input)) return input;
        const m=input.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
        if(!m) return todayStr;
        let [_,mm,dd,yy]=m; // eslint-disable-line
        if(yy.length===2) yy=(yy<50?'20':'19')+yy;
        return `${yy.padStart(2,'0')}-${dd.padStart(2,'0')}-${String(yy).padStart(4,'0')}`;
      }

      const openAppleMaps=(hub,addr)=>{
        const url=`http://maps.apple.com/?saddr=${encodeURIComponent(hub)}&daddr=${encodeURIComponent(addr)}`;
        window.open(url,"_blank");
      };

      const exportJSON=()=>{
        const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({hubs,selectedHub,jobs},null,2));
        const a=document.createElement("a"); a.href=dataStr; a.download=`dump-trailer-${Date.now()}.json`; a.click();
      };
      const importJSON=(file)=>{
        const reader=new FileReader();
        reader.onload=()=>{
          try{
            const obj=JSON.parse(reader.result);
            if(obj.hubs) setHubs(obj.hubs);
            if(obj.selectedHub) setSelectedHub(obj.selectedHub);
            if(obj.jobs) setJobs(obj.jobs);
          }catch(e){ alert("Import failed: invalid file"); }
        };
        reader.readAsText(file);
      };

      const tabs=[
        {key:"today",label:"Today"},
        {key:"tomorrow",label:"Tomorrow"},
        {key:"week",label:"This Week"},
        {key:"all",label:"All"},
      ];

      return (
        <div className="min-h-screen bg-gray-50 p-3 sm:p-4 max-w-xl mx-auto">
          <header className="mb-3">
            <h1 className="text-2xl font-semibold">Dump Trailer — iPhone</h1>
            <div className="mt-2 grid grid-cols-1 gap-2">
              <div className="flex gap-2 items-center">
                <label className="text-sm text-gray-600">Hub</label>
                <select className="flex-1 rounded-xl border px-3 py-2" value={selectedHub} onChange={e=>setSelectedHub(e.target.value)}>
                  {hubs.map(h=><option key={h} value={h}>{h}</option>)}
                </select>
              </div>
              <div className="flex gap-2">
                <input className="flex-1 rounded-xl border px-3 py-2" placeholder="Add new hub address" id="newHub" />
                <button
                  onClick={()=>{
                    const el=document.getElementById("newHub");
                    addHub(el.value.trim()); el.value="";
                  }}
                  className="rounded-xl px-3 py-2 bg-black text-white">Add Hub</button>
              </div>
            </div>
          </header>

          <div className="flex gap-2 mb-3">
            {tabs.map(t=>(
              <button key={t.key} onClick={()=>setTab(t.key)}
                className={`px-3 py-2 rounded-xl border ${tab===t.key?'bg-black text-white':'bg-white'}`}>{t.label}</button>
            ))}
          </div>

          <div className="bg-white rounded-2xl shadow p-3 mb-3">
            <div className="grid grid-cols-2 gap-2">
              <input className="rounded-xl border px-3 py-2" placeholder="Date (YYYY-MM-DD or MM/DD/YYYY)" value={compose.date} onChange={e=>setCompose({...compose,date:normalizeDate(e.target.value)})}/>
              <input className="rounded-xl border px-3 py-2" placeholder="Time (e.g., 10:30 AM)" value={compose.time} onChange={e=>setCompose({...compose,time:e.target.value})}/>
              <input className="rounded-xl border px-3 py-2 col-span-2" placeholder="Customer name" value={compose.customer} onChange={e=>setCompose({...compose,customer:e.target.value})}/>
              <input className="rounded-xl border px-3 py-2 col-span-2" placeholder="Address" value={compose.address} onChange={e=>setCompose({...compose,address:e.target.value})}/>
              <input className="rounded-xl border px-3 py-2" placeholder="Material" value={compose.material} onChange={e=>setCompose({...compose,material:e.target.value})}/>
              <input className="rounded-xl border px-3 py-2" placeholder="Load Size" value={compose.loadSize} onChange={e=>setCompose({...compose,loadSize:e.target.value})}/>
              <input className="rounded-xl border px-3 py-2" placeholder="Price" value={compose.price} onChange={e=>setCompose({...compose,price:e.target.value})}/>
              <select className="rounded-xl border px-3 py-2" value={compose.status} onChange={e=>setCompose({...compose,status:e.target.value})}>
                {['Scheduled','In Progress','Complete','Canceled'].map(s=><option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div className="mt-2 flex gap-2">
              <button onClick={addJob} className="rounded-xl px-4 py-2 bg-black text-white">Add Job</button>
              <button onClick={exportJSON} className="rounded-xl px-4 py-2 border">Export</button>
              <label className="rounded-xl px-4 py-2 border cursor-pointer">Import
                <input type="file" className="hidden" accept="application/json" onChange={e=> e.target.files && importJSON(e.target.files[0])}/>
              </label>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow p-3 mb-3">
            <p className="text-sm text-gray-600 mb-2">Paste rows (Date, Time, Customer, Address, Material, Load Size, Price, Status). Tabs or commas OK.</p>
            <textarea className="w-full rounded-xl border p-2 h-24" value={pasteText} onChange={e=>setPasteText(e.target.value)} placeholder={`08/13/2025, 9:00 AM, Sarah Branon, 5727 Old Augusta Hwy, Grovetown GA, Crush & Run, 3 tons, Scheduled`}></textarea>
            <div className="mt-2"><button onClick={pasteRows} className="rounded-xl px-4 py-2 bg-black text-white">Add Pasted Rows</button></div>
          </div>

          <div className="space-y-2">
            {filtered.map(job=>(
              <div key={job.id} className="bg-white rounded-2xl shadow p-3">
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-medium">{job.customer || "(No name)"}</div>
                    <div className="text-sm text-gray-600">{job.date} {job.time}</div>
                    <div className="text-sm">{job.address}</div>
                    <div className="text-xs text-gray-600">{job.material} • {job.loadSize} • ${job.price || '—'}</div>
                  </div>
                  <div className="flex flex-col gap-2 items-end">
                    <button className="rounded-xl px-3 py-2 bg-black text-white" onClick={()=>openAppleMaps(selectedHub,job.address)}>GO</button>
                    <select className="rounded-xl border px-2 py-1 text-sm" value={job.status} onChange={e=>updateJob(job.id,{status:e.target.value})}>
                      {['Scheduled','In Progress','Complete','Canceled'].map(s=><option key={s} value={s}>{s}</option>)}
                    </select>
                    <button className="text-red-600 text-sm" onClick={()=>removeJob(job.id)}>Delete</button>
                  </div>
                </div>
              </div>
            ))}
            {filtered.length===0 && (<div className="text-center text-gray-500">No jobs here yet.</div>)}
          </div>
          <footer className="h-10" />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
