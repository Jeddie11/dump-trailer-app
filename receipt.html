<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ASG — Invoice / Receipt</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .inv-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;max-width:720px;margin:12px auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111}
  .inv-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
  .badge-unpaid{background:#fef3c7;color:#92400e;border:1px solid #f59e0b}
  .badge-paid{background:#dcfce7;color:#166534;border:1px solid #22c55e}
  .muted{color:#6b7280;font-size:12px}
  .paid-watermark{display:none;position:fixed;inset:0;pointer-events:none;opacity:0.12;font-size:140px;font-weight:900;color:#16a34a;transform:rotate(-20deg);display:flex;align-items:center;justify-content:center}
  .paid-active .paid-watermark{display:flex}
  @media print{ .controls{display:none!important}; body{background:#fff} .inv-card{border:none;box-shadow:none} }
</style>
</head>
<body class="bg-slate-50">

<div id="wrap">
  <div class="paid-watermark">PAID</div>

  <div class="inv-card" id="invoiceCard">
    <div class="inv-head">
      <div>
        <div class="text-xl font-bold">Augusta Sand &amp; Gravel</div>
        <div class="muted">Call/Text: 706-589-0657</div>
      </div>
      <div id="statusBadge" class="badge badge-unpaid">INVOICE (DUE)</div>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-2">
      <div>
        <div class="text-xs text-gray-500">Invoice #</div>
        <div class="font-semibold" id="invoiceNo">—</div>
      </div>
      <div>
        <div class="text-xs text-gray-500">Invoice Date</div>
        <div class="font-semibold" id="invoiceDate">—</div>
      </div>
    </div>

    <hr class="my-2">

    <div class="grid grid-cols-2 gap-2">
      <p><span class="text-gray-500 text-xs">Customer</span><br><span id="cust" class="font-semibold"></span></p>
      <p><span class="text-gray-500 text-xs">Job Address</span><br><span id="addr" class="font-semibold"></span></p>
      <p><span class="text-gray-500 text-xs">Material</span><br><span id="mat" class="font-semibold"></span></p>
      <p><span class="text-gray-500 text-xs">Quantity</span><br><span id="qty" class="font-semibold"></span></p>
      <p><span class="text-gray-500 text-xs">Zone</span><br><span id="zone" class="font-semibold"></span></p>
      <p><span class="text-gray-500 text-xs">Notes</span><br><span id="notes" class="font-semibold"></span></p>
    </div>

    <hr class="my-2">

    <div class="grid grid-cols-2 gap-2">
      <p><span class="text-gray-500 text-xs">Amount</span><br>$<span id="amount" class="font-semibold">0.00</span></p>
      <p>
        <span class="text-gray-500 text-xs" id="amountLabel">Amount Due</span><br>
        $<span id="amountDue" class="font-semibold">0.00</span>
      </p>
    </div>

    <div id="paidMeta" class="mt-2 hidden">
      <div class="grid grid-cols-2 gap-2">
        <p><span class="text-gray-500 text-xs">Paid On</span><br><span id="paidOn" class="font-semibold">—</span></p>
        <p><span class="text-gray-500 text-xs">Method</span><br><span id="paidMethod" class="font-semibold">—</span></p>
      </div>
    </div>
  </div>
</div>

<!-- Controls (hidden on print) -->
<div class="controls max-w-[720px] mx-auto px-3 mb-6 flex flex-wrap gap-3 items-center">
  <label class="flex items-center gap-2"><input type="checkbox" id="paidToggle"> Mark as Paid</label>
  <select id="methodSel" class="border rounded-xl px-3 py-2">
    <option value="">Payment method…</option>
    <option>Cash</option>
    <option>Card</option>
    <option>Cash App</option>
    <option>Venmo</option>
    <option>Zelle</option>
    <option>Other</option>
  </select>
  <button onclick="window.print()" class="border rounded-xl px-3 py-2">Print / Download</button>
  <button onclick="history.back()" class="border rounded-xl px-3 py-2">Back</button>
</div>

<script>
(function(){
  // Load payload from index.html handoff
  let job;
  try { job = JSON.parse(localStorage.getItem('ASG_RECEIPT') || '{}'); } catch { job = {}; }

  // Fallbacks
  const nowISO = new Date().toISOString();
  const fmtDate = d => new Date(d).toLocaleDateString();
  const $ = id => document.getElementById(id);

  // Populate fields
  $("cust").textContent  = job.customerName || '';
  $("addr").textContent  = job.address || '';
  $("mat").textContent   = job.material || '';
  $("qty").textContent   = (job.quantity ?? '') + ' ' + (job.unit || '');
  $("zone").textContent  = job.zone || '';
  $("notes").textContent = job.notes || (job.paid ? 'Thank you!' : 'Payment due upon delivery unless noted.');
  $("amount").textContent    = Number(job.unitPrice || 0).toFixed(2);
  $("amountDue").textContent = Number(job.unitPrice || 0).toFixed(2);
  $("invoiceDate").textContent = fmtDate(job.date || nowISO);
  $("invoiceNo").textContent   = ('ASG-' + (job.customerName||'').replace(/\s+/g,'').slice(0,3).toUpperCase() + '-' + (job.date||nowISO).slice(2,10).replace(/-/g,''))

  const badge = $("statusBadge");
  const paidMeta = $("paidMeta");
  const paidOn = $("paidOn");
  const paidMethod = $("paidMethod");
  const wrap = document.getElementById('wrap');
  const toggle = $("paidToggle");
  const methodSel = $("methodSel");
  const amountLabel = $("amountLabel");

  // Initialize state from job
  job.paid = !!job.paid;
  toggle.checked = job.paid;
  if (job.method) methodSel.value = job.method;

  function applyPaidUI(){
    if (job.paid) {
      badge.textContent = "PAID INVOICE";
      badge.className = "badge badge-paid";
      amountLabel.textContent = "Amount Paid";
      paidMeta.classList.remove('hidden');
      paidOn.textContent = fmtDate(job.paidOn || nowISO);
      paidMethod.textContent = job.method || "Cash";
      wrap.classList.add('paid-active');
    } else {
      badge.textContent = "INVOICE (DUE)";
      badge.className = "badge badge-unpaid";
      amountLabel.textContent = "Amount Due";
      paidMeta.classList.add('hidden');
      wrap.classList.remove('paid-active');
    }
  }

  applyPaidUI();

  // Persist back to localStorage jobs if possible
  function persistBackToJobs() {
    try {
      const jobs = JSON.parse(localStorage.getItem('dt_jobs') || '[]');
      // Try to find by matching (customer + date + address + price)
      const idx = jobs.findIndex(j =>
        (j.customer||'') === (job.customerName||'') &&
        (j.address||'')  === (job.address||'') &&
        (j.date||'')     === (job.date||'') &&
        Number(j.price||0) === Number(job.unitPrice||0)
      );
      if (idx > -1) {
        jobs[idx].paid = job.paid;
        jobs[idx].paidMethod = job.method || '';
        jobs[idx].paidOn = job.paid ? (jobs[idx].paidOn || new Date().toISOString()) : null;
        localStorage.setItem('dt_jobs', JSON.stringify(jobs));
      }
    } catch(e) {}
  }

  // Events
  toggle.addEventListener('change', ()=>{
    job.paid = toggle.checked;
    if (job.paid) {
      job.paidOn = job.paidOn || new Date().toISOString();
      job.method = methodSel.value || job.method || "Cash";
    } else {
      job.paidOn = null;
    }
    localStorage.setItem('ASG_RECEIPT', JSON.stringify(job));
    persistBackToJobs();
    applyPaidUI();
  });

  methodSel.addEventListener('change', ()=>{
    job.method = methodSel.value || '';
    localStorage.setItem('ASG_RECEIPT', JSON.stringify(job));
    if (job.paid) paidMethod.textContent = job.method || '—';
    persistBackToJobs();
  });
})();
</script>
</body>
</html>
