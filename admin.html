<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ASG App — Safe Build</title>
<style>
  :root { --bg:#fafafa; --card:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background: var(--bg); color: var(--text); }
  h1 { font-size: 20px; margin: 0 0 12px; }
  h2 { font-size: 16px; margin: 0 0 10px; }
  .grid { display: grid; gap: 12px; }
  .card { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 12px; }
  label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; background:#fff; font-size:14px; }
  button { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--line); background:#111827; color:#fff; cursor:pointer; font-weight: 600; }
  button.secondary { background:#fff; color:#111827; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .muted { color: var(--muted); font-size:12px; }
  .output { padding:10px; border-radius:8px; background:#f3f4f6; font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }
  .flex { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
  .right { display:flex; justify-content:flex-end; gap:8px; }
  .pill { font-size: 12px; background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:999px; border:1px solid #c7d2fe; }
  .footer { margin-top: 10px; font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
  <h1>Augusta Sand & Gravel — Quick Quote & Invoice</h1>

  <div class="grid">
    <!-- Customer & Job -->
    <div class="card">
      <h2>Customer & Job Details</h2>
      <div class="row">
        <div>
          <label>Customer Name</label>
          <input id="custName" placeholder="Jane Doe" />
        </div>
        <div>
          <label>Phone</label>
          <input id="custPhone" inputmode="tel" placeholder="706-589-0657" />
        </div>
      </div>
      <label>Delivery Address</label>
      <input id="custAddr" placeholder="123 Main St, Augusta, GA 30907" />
      <div class="row">
        <div>
          <label>Job Date</label>
          <input id="jobDate" type="date" />
        </div>
        <div>
          <label>Payment Terms</label>
          <select id="terms">
            <option>Due upon delivery</option>
            <option>Net 7</option>
            <option>Net 15</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Quote Builder -->
    <div class="card">
      <h2>Build Quote</h2>
      <div class="row-3">
        <div>
          <label>Material</label>
          <select id="material"></select>
        </div>
        <div>
          <label>Tons</label>
          <select id="tons">
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>
        <div>
          <label>Zone</label>
          <select id="zone">
            <option>Z1</option>
            <option>Z2</option>
          </select>
        </div>
      </div>
      <div class="flex" style="margin-top:10px;">
        <button id="btnQuote">Calculate</button>
        <button class="secondary" id="btnCopy">Copy Quote Text</button>
        <span class="pill" id="statusPill">Prices: Aug 2025 (Locked)</span>
      </div>
      <div style="margin-top:10px;">
        <div class="muted">Result</div>
        <div id="quoteOutput" class="output">—</div>
      </div>
      <div class="right" style="margin-top:10px;">
        <button id="btnInvoice">Open Printable Invoice</button>
      </div>
      <div class="footer">
        Tip: “Copy Quote Text” is perfect for Messenger/iMessage. “Printable Invoice” lets you Save as PDF and share.
      </div>
    </div>
  </div>

<script>
// ========= ASG MASTER PRICES (Aug 2025, locked) =========
// Units: stone by tons (1–4). Fill Dirt by tons to match posting style.
// Z2 for Fill Dirt = same as Z1.
const ASG_PRICES = {
  "Fill Dirt": {
    Z1: { 1: 100, 2: 120, 3: 150, 4: 200 },
    Z2: { 1: 100, 2: 120, 3: 150, 4: 200 },
  },
  "Crush & Run": {
    Z1: { 1: 100, 2: 140, 3: 180, 4: 240 },
    Z2: { 1: 100, 2: 200, 3: 275, 4: 350 },
  },
  "#57 Stone": {
    Z1: { 1: 100, 2: 140, 3: 210, 4: 280 },
    Z2: { 1: 100, 2: 200, 3: 305, 4: 390 },
  },
  "#4 Stone": {
    // Only 1–2 tons offered per sheet
    Z1: { 1: 100, 2: 140 },
    Z2: { 1: 100, 2: 200 },
  },
};

// Aliases so “57”, “crusher run” still work if you wire in your own inputs later
const MATERIAL_ALIASES = {
  "crusher run": "Crush & Run",
  "crush & run": "Crush & Run",
  "57": "#57 Stone",
  "#57": "#57 Stone",
  "57 stone": "#57 Stone",
  "#4": "#4 Stone",
  "4 stone": "#4 Stone",
  "fill": "Fill Dirt",
  "fill dirt": "Fill Dirt",
};

// ——— Helpers
function normalizeMaterial(name) {
  if (!name) return null;
  const key = name.trim().toLowerCase();
  return MATERIAL_ALIASES[key] || Object.keys(ASG_PRICES).find(m => m.toLowerCase() === key) || null;
}

function getASGPrice(materialInput, zoneInput, tons) {
  const material = normalizeMaterial(materialInput);
  const zone = (zoneInput || "").toUpperCase(); // "Z1" or "Z2"
  const qty = Number(tons);

  if (!material || !ASG_PRICES[material]) {
    return { ok: false, reason: "Unknown material", materialResolved: material };
  }
  if (zone !== "Z1" && zone !== "Z2") {
    return { ok: false, reason: "Unknown zone. Use Z1 or Z2." };
  }
  if (!Number.isFinite(qty) || qty < 1) {
    return { ok: false, reason: "Invalid tonnage." };
  }

  const table = ASG_PRICES[material][zone] || {};
  const price = table[qty];

  if (price == null) {
    return {
      ok: false,
      reason: `${material} pricing is only available for: ${Object.keys(table).join("–")} tons in ${zone}.`,
    };
  }
  return { ok: true, material, zone, tons: qty, price };
}

// ——— UI wiring
const $material = document.getElementById("material");
const $tons = document.getElementById("tons");
const $zone = document.getElementById("zone");
const $quoteOutput = document.getElementById("quoteOutput");
const $btnQuote = document.getElementById("btnQuote");
const $btnCopy = document.getElementById("btnCopy");
const $btnInvoice = document.getElementById("btnInvoice");

const $custName = document.getElementById("custName");
const $custPhone = document.getElementById("custPhone");
const $custAddr = document.getElementById("custAddr");
const $jobDate = document.getElementById("jobDate");
const $terms = document.getElementById("terms");

// Populate material dropdown
(function init() {
  const mats = Object.keys(ASG_PRICES);
  mats.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m; opt.textContent = m;
    $material.appendChild(opt);
  });
  // Defaults
  $material.value = "#57 Stone";
  $tons.value = "4";
  $zone.value = "Z1";
  // Default date = today
  const today = new Date(); $jobDate.value = today.toISOString().slice(0,10);
  // Restore simple local memory
  try {
    const saved = JSON.parse(localStorage.getItem("asg-last")||"{}");
    if (saved.custName) $custName.value = saved.custName;
    if (saved.custPhone) $custPhone.value = saved.custPhone;
    if (saved.custAddr) $custAddr.value = saved.custAddr;
  } catch {}
  doQuote();
})();

function doQuote() {
  const res = getASGPrice($material.value, $zone.value, $tons.value);
  if (!res.ok) {
    $quoteOutput.textContent = `— ${res.reason}`;
    return res;
  }
  $quoteOutput.textContent = `${res.material} • ${res.tons} ton${res.tons>1?"s":""} • ${res.zone} → $${res.price}`;
  return res;
}

$btnQuote.addEventListener("click", doQuote);

$btnCopy.addEventListener("click", async () => {
  const res = doQuote();
  const name = $custName.value.trim();
  const addr = $custAddr.value.trim();
  const when = $jobDate.value ? new Date($jobDate.value).toLocaleDateString() : "TBD";
  const lines = [
    `Augusta Sand & Gravel — Quote`,
    `${res.ok ? `${res.material}, ${res.tons} ton${res.tons>1?"s":""} (${res.zone}) — $${res.price}` : $quoteOutput.textContent}`,
    name ? `Customer: ${name}` : ``,
    addr ? `Address: ${addr}` : ``,
    `Date: ${when}`,
    `Terms: ${$terms.value}`,
    `Call/Text: 706-589-0657`,
  ].filter(Boolean);
  const text = lines.join("\n");
  try { await navigator.clipboard.writeText(text); alert("Quote copied!"); } catch {
    // Fallback
    const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); ta.remove(); alert("Quote copied!");
  }
  // Save basics
  localStorage.setItem("asg-last", JSON.stringify({
    custName: $custName.value, custPhone: $custPhone.value, custAddr: $custAddr.value
  }));
});

$btnInvoice.addEventListener("click", () => {
  const res = doQuote();
  const invoiceNo = genInvoiceNumber();
  const when = $jobDate.value ? new Date($jobDate.value).toLocaleDateString() : "TBD";
  const name = esc($custName.value || "");
  const phone = esc($custPhone.value || "");
  const addr = esc($custAddr.value || "");
  const terms = esc($terms.value || "Due upon delivery");

  const lineTitle = res.ok ? `${res.material} — ${res.tons} ton${res.tons>1?"s":""} (${res.zone})` : "Line Item";
  const lineAmount = res.ok ? res.price : 0;

  const win = window.open("", "_blank");
  win.document.write(renderInvoiceHTML({
    invoiceNo, dateStr: when, customer: name, phone, address: addr, terms,
    lineTitle, amount: lineAmount
  }));
  win.document.close();
  // Optional: auto-open print dialog. Comment out if you don't want it.
  win.focus(); setTimeout(() => win.print(), 300);
});

// Simple invoice number like 2025-09-08-001 (increments per tab session)
function genInvoiceNumber() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const key = `asg-seq-${yyyy}${mm}${dd}`;
  let seq = Number(localStorage.getItem(key) || "0") + 1;
  localStorage.setItem(key, String(seq));
  return `${yyyy}-${mm}-${dd}-${String(seq).padStart(3,"0")}`;
}

function esc(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function renderInvoiceHTML({ invoiceNo, dateStr, customer, phone, address, terms, lineTitle, amount }) {
  const total = amount;
  return `<!doctype html>
  <html><head><meta charset="utf-8" />
  <title>Invoice ${invoiceNo} — Augusta Sand & Gravel</title>
  <style>
    :root { --line:#e5e7eb; --text:#111827; --muted:#6b7280; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px; color: var(--text); }
    h1 { font-size: 24px; margin: 0; }
    .muted { color: var(--muted); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .box { border:1px solid var(--line); border-radius:10px; padding:12px; }
    table { width:100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border-bottom:1px solid var(--line); text-align:left; padding:10px; font-size:14px; }
    tfoot td { border-top:2px solid var(--line); font-weight:700; }
    .right { text-align:right; }
    @media print {
      .noprint { display:none; }
      body { margin: 20px; }
    }
  </style>
  </head>
  <body>
    <div class="grid" style="align-items: start;">
      <div>
        <h1>Augusta Sand & Gravel</h1>
        <div class="muted">Material Hauling — Call/Text: 706-589-0657</div>
      </div>
      <div class="right">
        <div><strong>Invoice #:</strong> ${invoiceNo}</div>
        <div><strong>Date:</strong> ${esc(dateStr)}</div>
        <div><strong>Terms:</strong> ${terms}</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="box">
        <div style="font-weight:700; margin-bottom:6px;">Bill To</div>
        <div>${customer || "-"}</div>
        <div>${address || "-"}</div>
        <div>${phone || ""}</div>
      </div>
      <div class="box">
        <div style="font-weight:700; margin-bottom:6px;">From</div>
        <div>Augusta Sand & Gravel</div>
        <div>Serving the CSRA</div>
        <div>Call/Text: 706-589-0657</div>
      </div>
    </div>

    <table>
      <thead>
        <tr><th>Description</th><th class="right">Amount</th></tr>
      </thead>
      <tbody>
        <tr><td>${esc(lineTitle)}</td><td class="right">$${Number(amount).toFixed(0)}</td></tr>
      </tbody>
      <tfoot>
        <tr><td>Total</td><td class="right">$${Number(total).toFixed(0)}</td></tr>
      </tfoot>
    </table>

    <p class="muted" style="margin-top:16px;">Thank you for your business.</p>
    <button class="noprint" onclick="window.print()">Print / Save as PDF</button>
  </body></html>`;
}
</script>
</body>
</html>
